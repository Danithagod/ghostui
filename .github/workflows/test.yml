name: Test Suite

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  test-package:
    name: Test GhostUI Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm ci --force
          npm rebuild
      
      - name: Run package tests
        run: npm test --workspace=packages/ghostui
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: package-test-results
          path: packages/ghostui/coverage/
          retention-days: 30

  test-demo:
    name: Test Demo App
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm ci --force
          npm rebuild
      
      - name: Build package
        run: npm run build --workspace=packages/ghostui
      
      - name: Run demo app tests
        run: npm test --workspace=apps/demo
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: demo-test-results
          path: apps/demo/coverage/
          retention-days: 30

  test-docs:
    name: Test Docs App
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm ci --force
          npm rebuild
      
      - name: Build package
        run: npm run build --workspace=packages/ghostui
      
      - name: Run docs app tests
        run: npm test --workspace=apps/docs
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-test-results
          path: apps/docs/coverage/
          retention-days: 30

  build-verification:
    name: Verify Build Process
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm ci --force
          npm rebuild
      
      - name: Build package
        run: npm run build:package
      
      - name: Verify package dist directory
        run: |
          if [ ! -d "packages/ghostui/dist" ]; then
            echo "Error: Package dist directory not found"
            exit 1
          fi
          echo "✓ Package dist directory exists"
      
      - name: Build demo app
        run: npm run build --workspace=apps/demo
      
      - name: Verify demo build output
        run: |
          if [ ! -d "apps/demo/.next" ]; then
            echo "Error: Demo app .next directory not found"
            exit 1
          fi
          echo "✓ Demo app build output exists"
      
      - name: Build docs app
        run: npm run build --workspace=apps/docs
      
      - name: Verify docs build output
        run: |
          if [ ! -d "apps/docs/.next" ]; then
            echo "Error: Docs app .next directory not found"
            exit 1
          fi
          echo "✓ Docs app build output exists"

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm ci --force
          npm rebuild
      
      - name: Lint package
        run: npm run lint --workspace=packages/ghostui
        continue-on-error: true
      
      - name: Lint demo app
        run: npm run lint --workspace=apps/demo
        continue-on-error: true
      
      - name: Lint docs app
        run: npm run lint --workspace=apps/docs
        continue-on-error: true

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-package, test-demo, test-docs, build-verification]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Package Tests: ${{ needs.test-package.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Demo App Tests: ${{ needs.test-demo.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docs App Tests: ${{ needs.test-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Verification: ${{ needs.build-verification.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-package.result }}" != "success" ] || \
             [ "${{ needs.test-demo.result }}" != "success" ] || \
             [ "${{ needs.test-docs.result }}" != "success" ] || \
             [ "${{ needs.build-verification.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Some tests failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          fi
